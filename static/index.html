<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoOps Console</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .container {
            text-align: center;
            padding: 20px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            width: 90%;
            max-width: 600px;
            /* Widened slightly for better text display */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 400px;
            justify-content: space-between;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #00ff00;
            width: 100%;
            padding-bottom: 10px;
        }

        audio {
            width: 100%;
            margin-top: 10px;
            filter: invert(1);
            height: 30px;
        }

        /* Status Bar (Meta info like "Listening...") */
        #status-bar {
            font-size: 0.8rem;
            margin-bottom: 15px;
            opacity: 0.7;
            height: 1.2em;
            width: 100%;
            text-align: right;
        }

        .visualizer {
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 2px;
            margin-bottom: 10px;
            width: 100%;
        }

        .bar {
            width: 5px;
            background-color: #00ff00;
            transition: height 0.1s;
        }

        #record-btn {
            background-color: transparent;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            border-radius: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        #record-btn:hover {
            background-color: #00ff00;
            color: #1a1a1a;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        #record-btn.recording {
            background-color: #ff0000;
            border-color: #ff0000;
            color: white;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Flyover Styles */
        .flyover-btn {
            position: fixed;
            top: 20px;
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 50%;
            /* Circle */
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .flyover-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px #00ff00;
        }

        #help-btn {
            right: 20px;
        }

        #history-btn {
            left: 20px;
        }

        .flyover {
            position: fixed;
            top: 0;
            width: 350px;
            height: 100vh;
            background: #111;
            padding: 20px;
            box-sizing: border-box;
            transition: transform 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            border-bottom: none;
        }

        #help-panel {
            right: 0;
            border-left: 2px solid #00ff00;
            transform: translateX(100%);
        }

        #help-panel.open {
            transform: translateX(0);
        }

        #history-panel {
            left: 0;
            border-right: 2px solid #00ff00;
            transform: translateX(-100%);
        }

        #history-panel.open {
            transform: translateX(0);
        }

        .flyover h2 {
            font-size: 1.2rem;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
            margin-top: 0;
            text-transform: uppercase;
        }

        /* Active Display Area */
        #active-display {
            flex-grow: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* Start from top */
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            background: rgba(0, 255, 0, 0.02);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Message Cards */
        .card {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-radius: 5px;
            position: relative;
            text-align: left;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-card {
            border: 1px dashed #00ff00;
            background: rgba(0, 255, 0, 0.05);
            margin-right: 20px;
            align-self: flex-start;
            width: 80%;
        }

        .system-card {
            border: 1px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
            margin-left: 20px;
            align-self: flex-end;
            width: 80%;
        }

        .card-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .card-content {
            font-size: 1rem;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        /* History Items - Smaller versions of cards */
        .history-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .history-timestamp {
            font-size: 0.7rem;
            opacity: 0.5;
            margin-bottom: 5px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #44ff44;
        }
    </style>
</head>

<body>
    <!-- Buttons -->
    <button class="flyover-btn" id="help-btn">?</button>
    <button class="flyover-btn" id="history-btn">H</button>

    <!-- Help Panel -->
    <aside class="flyover" id="help-panel">
        <h2>Command Guide</h2>
        <p>Use voice commands to manage services.</p>
        <h3>Basic Commands</h3>
        <ul>
            <li>Restart a service<br><code>"Restart [service_name]"</code></li>
            <li>Scale a service<br><code>"Scale [service] to [N] replicas"</code></li>
            <li>Get Status<br><code>"Status of [service]"</code></li>
            <li>Get Logs<br><code>"Show logs for [service]"</code></li>
        </ul>
        <h3>Examples</h3>
        <ul>
            <li>"Restart payment gateway"</li>
            <li>"Scale checkout to 5"</li>
            <li>"Status of database"</li>
        </ul>
    </aside>

    <!-- History Panel -->
    <aside class="flyover" id="history-panel">
        <h2>Mission Log</h2>
        <div id="history-list">
            <!-- Items injected here -->
            <p style="opacity:0.5; text-align:center; padding:20px;">No logs recorded.</p>
        </div>
    </aside>

    <div class="container">
        <h1>EchoOps Active</h1>

        <!-- Status Bar -->
        <div id="status-bar">SYSTEM ONLINE. WAITING.</div>

        <!-- Main Display (Current Interaction) -->
        <div id="active-display">
            <!-- Content will be injected here. e.g.:
            <div class="card user-card">...</div>
            <div class="card system-card">...</div>
            -->
        </div>

        <!-- Visualizer -->
        <div class="visualizer" id="visualizer"></div>

        <!-- Inputs -->
        <button id="record-btn">INITIATE VOICE COMMAND</button>

        <audio id="player" controls>
            <source src="/static/latest_sitrep.wav" type="audio/wav">
        </audio>
    </div>

    <script>
        // --- UI Setup ---
        const visualizer = document.getElementById('visualizer');
        for (let i = 0; i < 40; i++) { // Increased bars
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.height = '5px';
            visualizer.appendChild(bar);
        }

        const player = document.getElementById('player');
        const statusBar = document.getElementById('status-bar');
        const recordBtn = document.getElementById('record-btn');
        const activeDisplay = document.getElementById('active-display');
        const historyList = document.getElementById('history-list');

        // Toggle Panels
        document.getElementById('help-btn').onclick = () => {
            document.getElementById('help-panel').classList.toggle('open');
            document.getElementById('history-panel').classList.remove('open');
        };
        document.getElementById('history-btn').onclick = () => {
            document.getElementById('history-panel').classList.toggle('open');
            document.getElementById('help-panel').classList.remove('open');
        };

        // --- Visualizer Animation ---
        function animate() {
            if (!player.paused) {
                document.querySelectorAll('.bar').forEach(bar => {
                    bar.style.height = Math.random() * 30 + 5 + 'px';
                });
            } else {
                document.querySelectorAll('.bar').forEach(bar => {
                    bar.style.height = '5px';
                });
            }
            requestAnimationFrame(animate);
        }
        animate();

        // --- Display Logic ---

        // State to track if we have an active "User" context to pair with a "System" response
        // or if the current display is "stale" and should be archived.
        let interactionActive = false;

        function addToHistory(htmlContent) {
            // Remove the "No logs" placeholder if valid
            if (historyList.querySelector('p')?.textContent.includes('No logs')) {
                historyList.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'history-item';

            const timestamp = new Date().toLocaleTimeString();
            item.innerHTML = `<div class="history-timestamp">${timestamp}</div>` + htmlContent;

            // Prepend (Newest at top)
            historyList.insertBefore(item, historyList.firstChild);
        }

        function clearActiveDisplay() {
            if (activeDisplay.children.length > 0) {
                // Determine what to archive. 
                // We archive whatever HTML is currently inside active-display
                const contentToArchive = activeDisplay.innerHTML;
                addToHistory(contentToArchive);
            }
            activeDisplay.innerHTML = '';
        }

        function renderUserCard(text) {
            // If interaction was not active (e.g. fresh start), clear any old visible system msg
            // However, we said "When a new command is received, populate another section".
            // So YES, always clear previous context when User speaks.

            clearActiveDisplay();

            const card = document.createElement('div');
            card.className = 'card user-card';
            card.innerHTML = `
                <div class="card-label">COMMANDER</div>
                <div class="card-content">${text}</div>
            `;
            activeDisplay.appendChild(card);
            interactionActive = true;

            // Auto scroll
            activeDisplay.scrollTop = activeDisplay.scrollHeight;
        }

        function renderSystemCard(text, isError = false, title = "ECHO_OPS") {
            // If we are appending to a user command, do NOT clear.
            // If this is a standalone signal (SitRep) and no user command is currently "pending", 
            // then we might want to clear the previous stale context.

            if (!interactionActive && activeDisplay.children.length > 0) {
                // If there's something there but it's not part of this "turn", archive it.
                clearActiveDisplay();
            }

            // If we are pairing, we keep the User card and add System card.
            // Then the interaction is considered "complete" but we leave it visible until NEXT event.

            const card = document.createElement('div');
            card.className = 'card system-card';
            if (isError) card.style.borderColor = "#ff0000";

            card.innerHTML = `
                <div class="card-label">
                    <span>${title}</span>
                </div>
                <div class="card-content"></div>
            `;
            activeDisplay.appendChild(card);

            // Typewriter effect
            const contentDiv = card.querySelector('.card-content');
            let i = 0;
            const speed = 20;
            function type() {
                if (i < text.length) {
                    contentDiv.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                    activeDisplay.scrollTop = activeDisplay.scrollHeight;
                }
            }
            type();

            // Reset interaction flag because turn is done
            interactionActive = false;
        }

        // --- Core Application Logic ---

        let lastStatusTime = "";
        let lastSentTranscript = "";

        // Status Polling (SitReps / Incidents)
        setInterval(() => {
            fetch('/static/status.json?t=' + new Date().getTime())
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    if (data && data.timestamp !== lastStatusTime) {
                        lastStatusTime = data.timestamp;

                        // This is a new event from System.
                        // If it's audio, play it.
                        // Render card.

                        let msg = data.text;
                        if (!msg) return;

                        // Filter out echoes of our own commands (handled by direct response)
                        if (msg.startsWith("COMMAND RECEIVED") && lastSentTranscript && msg.includes(lastSentTranscript)) {
                            console.log("Skipping self-echo status update");
                            return;
                        }

                        // If audio available, auto play
                        if (data.audio_available) {
                            player.src = "/static/latest_sitrep.wav?t=" + new Date().getTime();
                            player.play().catch(e => console.log("Autoplay blocked"));
                            statusBar.textContent = "INCOMING TRANSMISSION...";
                        } else {
                            statusBar.textContent = "TEXT TRANSMISSION RECEIVED";
                        }

                        renderSystemCard(msg, false, "INCOMING SIGNAL");
                    }
                })
                .catch(e => console.log("Poll error", e));
        }, 3000);

        // Voice Command Logic
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recordBtn.onclick = () => {
                if (recordBtn.classList.contains('recording')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            };

            recognition.onstart = () => {
                recordBtn.classList.add('recording');
                recordBtn.textContent = "LISTENING...";
                statusBar.textContent = "MICROPHONE ACTIVE";
                statusBar.style.color = "#00ff00";
            };

            recognition.onend = () => {
                recordBtn.classList.remove('recording');
                recordBtn.textContent = "INITIATE VOICE COMMAND";
                if (statusBar.textContent === "MICROPHONE ACTIVE") {
                    statusBar.textContent = "PROCESSING...";
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                lastSentTranscript = transcript;
                console.log("Transcript:", transcript);

                // 1. Display User Command
                renderUserCard(transcript);
                statusBar.textContent = "SENDING TO HQ...";

                // 2. Send to Backend
                fetch('/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript: transcript, user_id: "web_user_01" })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Response:", data);
                        statusBar.textContent = "RESPONSE RECEIVED";

                        const message = data.message || "Command Processed.";
                        const isError = (data.intent && data.intent.tool_name === "refusal");

                        // 3. Display System Response
                        renderSystemCard(message, isError);
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        statusBar.textContent = "TRANSMISSION FAILED";
                        statusBar.style.color = "red";
                        renderSystemCard("Error: Failed to reach command server.", true, "SYSTEM ERROR");
                    });
            };

            recognition.onerror = (event) => {
                statusBar.textContent = "ERROR: " + event.error;
                statusBar.style.color = "red";
                recordBtn.classList.remove('recording');
                recordBtn.textContent = "INITIATE VOICE COMMAND";
            };

        } else {
            recordBtn.textContent = "VOICE UNAVAILABLE";
            recordBtn.disabled = true;
            renderSystemCard("Warning: Web Speech API not supported in this browser. Voice commands disabled.", true);
        }
    </script>
</body>

</html>