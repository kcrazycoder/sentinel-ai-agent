apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: ${SERVICE_NAME}
  labels:
    cloud.googleapis.com/location: ${REGION}
  annotations:
    run.googleapis.com/launch-stage: BETA
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
      labels:
        env: ${DD_ENV}
        service: ${DD_SERVICE}
        version: ${DD_VERSION_LABEL}
    spec:
      containers:
      - image: ${IMAGE_URL}
        ports:
        - containerPort: 8080
        env:
        - name: GOOGLE_CLOUD_PROJECT
          value: ${PROJECT_ID}
        - name: DD_AGENT_HOST
          value: "localhost"
        - name: DD_TRACE_AGENT_PORT
          value: "8126"
        - name: DD_SERVICE
          value: "${DD_SERVICE}"
        - name: DD_ENV
          value: "${DD_ENV}"
        - name: DD_VERSION
          value: "${DD_VERSION}"
        - name: DD_LOGS_INJECTION
          value: "${DD_LOGS_INJECTION}"
        - name: DD_LLMOBS_ENABLED
          value: "${DD_LLMOBS_ENABLED}"
        - name: DD_LLMOBS_ML_APP
          value: "${DD_LLMOBS_ML_APP}"
        - name: ELEVENLABS_API_KEY
          value: "${ELEVENLABS_API_KEY}"${APP_ENV_VARS_BLOCK}
            
      - image: gcr.io/datadoghq/agent:latest
        name: datadog-agent
        env:
        - name: DD_HOSTNAME
          value: "${DD_SERVICE}"
        - name: DD_API_KEY
          value: "${DD_API_KEY}"
        - name: DD_SITE
          value: "${DD_SITE}"
        - name: DD_APM_ENABLED
          value: "true"
        - name: DD_APM_NON_LOCAL_TRAFFIC
          value: "true"
        - name: DD_DOGSTATSD_NON_LOCAL_TRAFFIC
          value: "true"
        resources:
          limits:
            memory: 1Gi
